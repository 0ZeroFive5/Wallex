"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _electron = require("electron");

var _electronWallpaper = _interopRequireDefault(require("../electronWallpaper"));

var _path = _interopRequireDefault(require("path"));

var _fs = _interopRequireDefault(require("fs"));

_electron.app.allowRendererProcessReuse = true;
var wallpaperWindows = [];
var tray;
var currentScreen;
var currentScreenIdx;
var screens;

var pathToData = _electron.app.getPath('userData');

var pathsToWallpapers = [];

var loadWallpapers = function loadWallpapers() {
  try {
    var dirRaw = _fs["default"].readdirSync(_path["default"].join(pathToData, 'wallpapers'), {
      withFileTypes: true
    });

    dirRaw.forEach(function (dir) {
      if (!dir.isDirectory()) {
        return;
      }

      pathsToWallpapers.push({
        path: _path["default"].join(pathToData, 'wallpapers', dir.name, 'index.html'),
        name: dir.name
      });
    });
  } catch (_unused) {
    _fs["default"].mkdirSync(_path["default"].join(pathToData, 'wallpapers'));
  }
};

loadWallpapers(); // Initial load

var getOffsetX = function getOffsetX() {
  if (!currentScreen || currentScreenIdx === null || !screens) {
    throw Error("Current screen is unset!");
  }

  if (currentScreenIdx === 0) {
    return 0;
  } else {
    var screensToTheLeft = screens.slice(0, currentScreenIdx);
    return screensToTheLeft.reduce(function (sum, item) {
      return sum + item.bounds.width;
    }, 0); // My trial and error approach to windows positioning system
  }
};

var destroyWallpaper = function destroyWallpaper(idx) {
  if (wallpaperWindows[idx]) {
    wallpaperWindows[idx].close();
    wallpaperWindows = wallpaperWindows.filter(function (_, index) {
      return index !== idx;
    });
  }
};

var createWallpaperWindow = function createWallpaperWindow(pathToWallpaper) {
  if (!currentScreen || currentScreenIdx === null || !screens) {
    throw Error("Current screen is unset!");
  }

  wallpaperWindows[currentScreenIdx] = new _electron.BrowserWindow({
    width: 1000,
    // Initial value cuz electron || windows (I don't know what's the problem at this point)
    height: 1000,
    // Initial value cuz electron || windows (I don't know what's the problem at this point)
    autoHideMenuBar: true,
    frame: false,
    transparent: true // webPreferences: {
    //   nodeIntegration: true,
    //   contextIsolation: false,
    //   enableRemoteModule: true
    // }, // 3 fucking lines cuz electron is "SECURE" now
    // The lines above allow node modules in wallpapers

  });
  wallpaperWindows[currentScreenIdx].loadFile(pathToWallpaper);

  _electronWallpaper["default"].attachWindow(wallpaperWindows[currentScreenIdx], getOffsetX(), currentScreen.bounds.y, currentScreen.bounds.width, currentScreen.bounds.height);
};

var setCurrentScreen = function setCurrentScreen(idx, pathToWallpaper) {
  if (!screens) {
    throw Error("Screens hasn't been initialized!");
  }

  currentScreen = screens[idx];
  currentScreenIdx = idx;
  destroyWallpaper(idx);
  createWallpaperWindow(pathToWallpaper);
};

var createTray = function createTray() {
  if (!screens) {
    throw Error("Screens hasn't been initialized!");
  }

  tray = new _electron.Tray(_path["default"].join(__dirname, '../public/logo.png'));

  var ctxMenu = _electron.Menu.buildFromTemplate([].concat((0, _toConsumableArray2["default"])(screens.map(function (_, idx) {
    return {
      label: "Screen ".concat(idx + 1),
      type: 'submenu',
      submenu: [{
        label: 'Disable',
        type: 'normal',
        click: function click() {
          return destroyWallpaper(idx);
        }
      }].concat((0, _toConsumableArray2["default"])(pathsToWallpapers.map(function (item) {
        return {
          label: item.name,
          type: 'normal',
          click: function click() {
            return setCurrentScreen(idx, item.path);
          }
        };
      })))
    };
  })), [// Allows the user to pick a wallpaper for each screen
  {
    label: 'wallpapers',
    type: 'normal',
    click: function click() {
      _electron.dialog.showOpenDialog({
        title: 'Add your wallpaper',
        defaultPath: _path["default"].join(pathToData, 'wallpapers'),
        buttonLabel: '-->'
      }).then(function () {
        var _tray;

        pathsToWallpapers.length = 0;
        loadWallpapers();
        (_tray = tray) === null || _tray === void 0 ? void 0 : _tray.destroy();
        createTray();
      }); // Should refresh the wallpapers

    }
  }, {
    label: 'quit',
    type: 'normal',
    click: function click() {
      wallpaperWindows.map(function (_, idx) {
        return destroyWallpaper(idx);
      });

      _electron.app.quit();
    }
  }]));

  tray.setToolTip('Wallex');
  tray.setContextMenu(ctxMenu);
};

_electron.app.on('ready', function () {
  screens = _electron.screen.getAllDisplays().sort(function (a, b) {
    return a.bounds.x - b.bounds.x;
  }); // Electron can't into multi display setups

  createTray();
});

_electron.app.on('window-all-closed', function () {}); // Overwrites the default exit behaviour
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC50cyJdLCJuYW1lcyI6WyJhcHAiLCJhbGxvd1JlbmRlcmVyUHJvY2Vzc1JldXNlIiwid2FsbHBhcGVyV2luZG93cyIsInRyYXkiLCJjdXJyZW50U2NyZWVuIiwiY3VycmVudFNjcmVlbklkeCIsInNjcmVlbnMiLCJwYXRoVG9EYXRhIiwiZ2V0UGF0aCIsInBhdGhzVG9XYWxscGFwZXJzIiwibG9hZFdhbGxwYXBlcnMiLCJkaXJSYXciLCJmcyIsInJlYWRkaXJTeW5jIiwicGF0aCIsImpvaW4iLCJ3aXRoRmlsZVR5cGVzIiwiZm9yRWFjaCIsImRpciIsImlzRGlyZWN0b3J5IiwicHVzaCIsIm5hbWUiLCJta2RpclN5bmMiLCJnZXRPZmZzZXRYIiwiRXJyb3IiLCJzY3JlZW5zVG9UaGVMZWZ0Iiwic2xpY2UiLCJyZWR1Y2UiLCJzdW0iLCJpdGVtIiwiYm91bmRzIiwid2lkdGgiLCJkZXN0cm95V2FsbHBhcGVyIiwiaWR4IiwiY2xvc2UiLCJmaWx0ZXIiLCJfIiwiaW5kZXgiLCJjcmVhdGVXYWxscGFwZXJXaW5kb3ciLCJwYXRoVG9XYWxscGFwZXIiLCJCcm93c2VyV2luZG93IiwiaGVpZ2h0IiwiYXV0b0hpZGVNZW51QmFyIiwiZnJhbWUiLCJ0cmFuc3BhcmVudCIsImxvYWRGaWxlIiwiZWxlY3Ryb25XYWxscGFwZXIiLCJhdHRhY2hXaW5kb3ciLCJ5Iiwic2V0Q3VycmVudFNjcmVlbiIsImNyZWF0ZVRyYXkiLCJUcmF5IiwiX19kaXJuYW1lIiwiY3R4TWVudSIsIk1lbnUiLCJidWlsZEZyb21UZW1wbGF0ZSIsIm1hcCIsImxhYmVsIiwidHlwZSIsInN1Ym1lbnUiLCJjbGljayIsImRpYWxvZyIsInNob3dPcGVuRGlhbG9nIiwidGl0bGUiLCJkZWZhdWx0UGF0aCIsImJ1dHRvbkxhYmVsIiwidGhlbiIsImxlbmd0aCIsImRlc3Ryb3kiLCJxdWl0Iiwic2V0VG9vbFRpcCIsInNldENvbnRleHRNZW51Iiwib24iLCJzY3JlZW4iLCJnZXRB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Q0FBdUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge2FwcCwgTWVudSwgVHJheSwgQnJvd3NlcldpbmRvdywgc2NyZWVuLCBNZW51SXRlbUNvbnN0cnVjdG9yT3B0aW9ucywgZGlhbG9nfSBmcm9tICdlbGVjdHJvbic7XHJcbmltcG9ydCBlbGVjdHJvbldhbGxwYXBlciBmcm9tICcuLi9lbGVjdHJvbldhbGxwYXBlcic7XHJcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xyXG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xyXG5cclxuYXBwLmFsbG93UmVuZGVyZXJQcm9jZXNzUmV1c2UgPSB0cnVlO1xyXG5cclxubGV0IHdhbGxwYXBlcldpbmRvd3M6IEJyb3dzZXJXaW5kb3dbXSA9IFtdO1xyXG5sZXQgdHJheTogVHJheSB8IG51bGw7XHJcbmxldCBjdXJyZW50U2NyZWVuOiBFbGVjdHJvbi5EaXNwbGF5IHwgbnVsbDtcclxubGV0IGN1cnJlbnRTY3JlZW5JZHg6IG51bWJlciB8IG51bGw7XHJcblxyXG5pbnRlcmZhY2UgV2FsbHBhcGVyIHtcclxuICBwYXRoOiBzdHJpbmcsXHJcbiAgbmFtZTogc3RyaW5nXHJcbn1cclxuXHJcbmxldCBzY3JlZW5zOiBFbGVjdHJvbi5EaXNwbGF5W10gfCBudWxsO1xyXG5jb25zdCBwYXRoVG9EYXRhID0gYXBwLmdldFBhdGgoJ3VzZXJEYXRhJyk7XHJcbmNvbnN0IHBhdGhzVG9XYWxscGFwZXJzOiBXYWxscGFwZXJbXSA9IFtdO1xyXG5cclxuY29uc3QgbG9hZFdhbGxwYXBlcnMgPSAoKSA9PiB7XHJcbiAgdHJ5IHtcclxuICAgIGNvbnN0IGRpclJhdyA9IGZzLnJlYWRkaXJTeW5jKHBhdGguam9pbihwYXRoVG9EYXRhLCAnd2FsbHBhcGVycycpLCB7IHdpdGhGaWxlVHlwZXM6IHRydWUgfSk7XHJcbiAgICBkaXJSYXcuZm9yRWFjaCgoZGlyOiBmcy5EaXJlbnQpID0+IHtcclxuICAgICAgaWYgKCFkaXIuaXNEaXJlY3RvcnkoKSkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgICBwYXRoc1RvV2FsbHBhcGVycy5wdXNoKHtwYXRoOiBwYXRoLmpvaW4ocGF0aFRvRGF0YSwgJ3dhbGxwYXBlcnMnLCBkaXIubmFtZSwgJ2luZGV4Lmh0bWwnKSwgbmFtZTogZGlyLm5hbWV9KTtcclxuICAgIH0pO1xyXG4gIH0gY2F0Y2gge1xyXG4gICAgZnMubWtkaXJTeW5jKHBhdGguam9pbihwYXRoVG9EYXRhLCAnd2FsbHBhcGVycycpKTtcclxuICB9XHJcbn1cclxuXHJcbmxvYWRXYWxscGFwZXJzKCk7IC8vIEluaXRpYWwgbG9hZFxyXG5cclxuY29uc3QgZ2V0T2Zmc2V0WCA9ICgpID0+IHtcclxuICBpZiAoIWN1cnJlbnRTY3JlZW4gfHwgY3VycmVudFNjcmVlbklkeCA9PT0gbnVsbCB8fCAhc2NyZWVucykge1xyXG4gICAgdGhyb3cgRXJyb3IoXCJDdXJyZW50IHNjcmVlbiBpcyB1bnNldCFcIik7XHJcbiAgfVxyXG4gIGlmIChjdXJyZW50U2NyZWVuSWR4ID09PSAwKSB7XHJcbiAgICByZXR1cm4gMDtcclxuICB9IGVsc2Uge1xyXG4gICAgY29uc3Qgc2NyZWVuc1RvVGhlTGVmdCA9IHNjcmVlbnMuc2xpY2UoMCwgY3VycmVudFNjcmVlbklkeCk7XHJcbiAgICByZXR1cm4gc2NyZWVuc1RvVGhlTGVmdC5yZWR1Y2UoKHN1bSwgaXRlbSkgPT4gc3VtICsgaXRlbS5ib3VuZHMud2lkdGgsIDApOyAvLyBNeSB0cmlhbCBhbmQgZXJyb3IgYXBwcm9hY2ggdG8gd2luZG93cyBwb3NpdGlvbmluZyBzeXN0ZW1cclxuICB9XHJcbn1cclxuXHJcbmNvbnN0IGRlc3Ryb3lXYWxscGFwZXIgPSAoaWR4OiBudW1iZXIpID0+IHtcclxuICBpZiAod2FsbHBhcGVyV2luZG93c1tpZHhdKSB7XHJcbiAgICB3YWxscGFwZXJXaW5kb3dzW2lkeF0uY2xvc2UoKTtcclxuICAgIHdhbGxwYXBlcldpbmRvd3MgPSB3YWxscGFwZXJXaW5kb3dzLmZpbHRlcigoXywgaW5kZXgpID0+IGluZGV4ICE9PSBpZHgpO1xyXG4gIH1cclxufVxyXG5cclxuY29uc3QgY3JlYXRlV2FsbHBhcGVyV2luZG93ID0gZnVuY3Rpb24ocGF0aFRvV2FsbHBhcGVyOiBzdHJpbmcpIHtcclxuICBpZiAoIWN1cnJlbnRTY3JlZW4gfHwgY3VycmVudFNjcmVlbklkeCA9PT0gbnVsbCB8fCAhc2NyZWVucykge1xyXG4gICAgdGhyb3cgRXJyb3IoXCJDdXJyZW50IHNjcmVlbiBpcyB1bnNldCFcIik7XHJcbiAgfVxyXG4gIHdhbGxwYXBlcldpbmRvd3NbY3VycmVudFNjcmVlbklkeF0gPSBuZXcgQnJvd3NlcldpbmRvdyh7XHJcbiAgICB3aWR0aDogMTAwMCwgLy8gSW5pdGlhbCB2YWx1ZSBjdXogZWxlY3Ryb24gfHwgd2luZG93cyAoSSBkb24ndCBrbm93IHdoYXQncyB0aGUgcHJvYmxlbSBhdCB0aGlzIHBvaW50KVxyXG4gICAgaGVpZ2h0OiAxMDAwLCAvLyBJbml0aWFsIHZhbHVlIGN1eiBlbGVjdHJvbiB8fCB3aW5kb3dzIChJIGRvbid0IGtub3cgd2hhdCdzIHRoZSBwcm9ibGVtIGF0IHRoaXMgcG9pbnQpXHJcbiAgICBhdXRvSGlkZU1lbnVCYXI6IHRydWUsXHJcbiAgICBmcmFtZTogZmFsc2UsXHJcbiAgICB0cmFuc3BhcmVudDogdHJ1ZSxcclxuICAgIC8vIHdlYlByZWZlcmVuY2VzOiB7XHJcbiAgICAvLyAgIG5vZGVJbnRlZ3JhdGlvbjogdHJ1ZSxcclxuICAgIC8vICAgY29udGV4dElzb2xhdGlvbjogZmFsc2UsXHJcbiAgICAvLyAgIGVuYWJsZVJlbW90ZU1vZHVsZTogdHJ1ZVxyXG4gICAgLy8gfSwgLy8gMyBmdWNraW5nIGxpbmVzIGN1eiBlbGVjdHJvbiBpcyBcIlNFQ1VSRVwiIG5vd1xyXG4gICAgLy8gVGhlIGxpbmVzIGFib3ZlIGFsbG93IG5vZGUgbW9kdWxlcyBpbiB3YWxscGFwZXJzXHJcbiAgfSk7XHJcbiAgd2FsbHBhcGVyV2luZG93c1tjdXJyZW50U2NyZWVuSWR4XS5sb2FkRmlsZShwYXRoVG9XYWxscGFwZXIpO1xyXG4gIGVsZWN0cm9uV2FsbHBhcGVyLmF0dGFjaFdpbmRvdyh3YWxscGFwZXJXaW5kb3dzW2N1cnJlbnRTY3JlZW5JZHhdLCBnZXRPZmZzZXRYKCksXHJcbiAgICBjdXJyZW50U2NyZWVuLmJvdW5kcy55LCBjdXJyZW50U2NyZWVuLmJvdW5kcy53aWR0aCwgY3VycmVudFNjcmVlbi5ib3VuZHMuaGVpZ2h0KTtcclxufTtcclxuXHJcbmNvbnN0IHNldEN1cnJlbnRTY3JlZW4gPSAoaWR4OiBudW1iZXIsIHBhdGhUb1dhbGxwYXBlcjogc3RyaW5nKSA9PiB7XHJcbiAgaWYgKCFzY3JlZW5zKSB7XHJcbiAgICB0aHJvdyBFcnJvcihcIlNjcmVlbnMgaGFzbid0IGJlZW4gaW5pdGlhbGl6ZWQhXCIpO1xyXG4gIH1cclxuICBjdXJyZW50U2NyZWVuID0gc2NyZWVuc1tpZHhdO1xyXG4gIGN1cnJlbnRTY3JlZW5JZHggPSBpZHg7XHJcbiAgZGVzdHJveVdhbGxwYXBlcihpZHgpO1xyXG4gIGNyZWF0ZVdhbGxwYXBlcldpbmRvdyhwYXRoVG9XYWxscGFwZXIpO1xyXG59XHJcblxyXG5jb25zdCBjcmVhdGVUcmF5ID0gKCkgPT4ge1xyXG4gIGlmICghc2NyZWVucykge1xyXG4gICAgdGhyb3cgRXJyb3IoXCJTY3JlZW5zIGhhc24ndCBiZWVuIGluaXRpYWxpemVkIVwiKTtcclxuICB9XHJcbiAgdHJheSA9IG5ldyBUcmF5KHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi9wdWJsaWMvbG9nby5wbmcnKSk7XHJcbiAgY29uc3QgY3R4TWVudSA9IE1lbnUuYnVpbGRGcm9tVGVtcGxhdGUoW1xyXG4gICAgLi4uKHNjcmVlbnMubWFwKChfLCBpZHgpOiBNZW51SXRlbUNvbnN0cnVjdG9yT3B0aW9ucyA9PiB7XHJcbiAgICAgIHJldHVybiB7IGxhYmVsOiBgU2NyZWVuICR7aWR4KzF9YCwgdHlwZTogJ3N1Ym1lbnUnLCBzdWJtZW51OiBbXHJcbiAgICAgICAgeyBsYWJlbDogJ0Rpc2FibGUnLCB0eXBlOiAnbm9ybWFsJywgY2xpY2s6ICgpID0+IGRlc3Ryb3lXYWxscGFwZXIoaWR4KSB9LFxyXG4gICAgICAgIC4uLihwYXRoc1RvV2FsbHBhcGVycy5tYXAoKGl0ZW0pOiBNZW51SXRlbUNvbnN0cnVjdG9yT3B0aW9ucyA9PiAoeyBsYWJlbDogaXRlbS5uYW1lLCB0eXBlOiAnbm9ybWFsJywgY2xpY2s6ICgpID0+IHNldEN1cnJlbnRTY3JlZW4oaWR4LCBpdGVtLnBhdGgpIH0pKSlcclxuICAgICAgXSB9XHJcbiAgICB9KSksIC8vIEFsbG93cyB0aGUgdXNlciB0byBwaWNrIGEgd2FsbHBhcGVyIGZvciBlYWNoIHNjcmVlblxyXG4gICAgeyBsYWJlbDogJ3dhbGxwYXBlcnMnLCB0eXBlOiAnbm9ybWFsJywgY2xpY2s6ICgpID0+IHtcclxuICAgICAgZGlhbG9nLnNob3dPcGVuRGlhbG9nKHsgdGl0bGU6ICdBZGQgeW91ciB3YWxscGFwZXInLCBkZWZhdWx0UGF0aDogcGF0aC5qb2luKHBhdGhUb0RhdGEsICd3YWxscGFwZXJzJyksXHJcbiAgICAgIGJ1dHRvbkxhYmVsOiAnLS0+JyB9KS50aGVuKCgpID0+IHsgcGF0aHNUb1dhbGxwYXBlcnMubGVuZ3RoID0gMDsgbG9hZFdhbGxwYXBlcnMoKTsgdHJheT8uZGVzdHJveSgpOyBjcmVhdGVUcmF5KCkgfSk7IC8vIFNob3VsZCByZWZyZXNoIHRoZSB3YWxscGFwZXJzXHJcbiAgICB9IH0sXHJcbiAgICB7IGxhYmVsOiAncXVpdCcsIHR5cGU6ICdub3JtYWwnLCBjbGljazogKCkgPT4geyBcclxuICAgICAgd2FsbHBhcGVyV2luZG93cy5tYXAoKF8sIGlkeCkgPT4gZGVzdHJveVdhbGxwYXBlcihpZHgpKTtcclxuICAgICAgYXBwLnF1aXQoKTtcclxuICAgIH0gfVxyXG4gIF0pO1xyXG4gIHRyYXkuc2V0VG9vbFRpcCgnV2FsbGV4Jyk7XHJcbiAgdHJheS5zZXRDb250ZXh0TWVudShjdHhNZW51KTtcclxufVxyXG5cclxuXHJcbmFwcC5vbigncmVhZHknLCAoKSA9PiB7XHJcbiAgc2NyZWVucyA9IHNjcmVlbi5nZXRBbGxEaXNwbGF5cygpLnNvcnQoKGEsIGIpID0+IGEuYm91bmRzLnggLSBiLmJvdW5kcy54KTsgLy8gRWxlY3Ryb24gY2FuJ3QgaW50byBtdWx0aSBkaXNwbGF5IHNldHVwc1xyXG4gIGNyZWF0ZVRyYXkoKTtcclxufSk7XHJcblxyXG5hcHAub24oJ3dpbmRvdy1hbGwtY2xvc2VkJywgKCkgPT4ge30pOyAvLyBPdmVyd3JpdGVzIHRoZSBkZWZhdWx0IGV4aXQgYmVoYXZpb3VyIl19